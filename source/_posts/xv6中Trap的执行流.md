---
title: xv6中Trap的执行流
date: 2023-11-09 13:48:36
tags:
- OS
- XV6
---
> 关于 xv6 中 trap 机制的实现及执行流程，Robert 教授讲得实在是太好了，让我实在不忍心用自己的话记录关于这一节课知识的理解，以防出现任何违背了 Robert 教授原本意愿的地方。因此，本文中记录的绝大多数都是 Robert 教授原话的翻译，只在些许小地方加入了作者自己理解，特别感谢[翻译者](https://github.com/PKUFlyingPig)准确用心的翻译。

# Trap的执行流程

当在 shell 中使用 write 系统调用时，操作系统将从用户态转变为内核态，从而请求内核提供服务。实际上，write 通过执行 ecall 指令来请求系统调用，ecall 指令会切换到具有 supervisor mode 的内核中，这里涉及到的其实就是系统调用方面的知识了。write 的本质其实就是通过 Trap（陷入），用户程序主动将处理器控制权交给操作系统，由操作系统内核提供需要的服务，然后操作系统再将控制权还给用户程序，下图是 write 系统调用的执行流程。

![Trap执行流程](/images/Trap执行流程.png)