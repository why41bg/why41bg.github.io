<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>MIT 6.S081 Operating System Enginerring Lab Page tables | Blog</title><meta name="author" content="why"><meta name="copyright" content="why"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="å¾ˆå–œæ¬¢ Frans æ•™æˆçš„å¼€åœºç™½ï¼šå½“æˆ‘è¿˜æ˜¯ä¸ªå­¦ç”Ÿå¹¶ç¬¬ä¸€æ¬¡å¬åˆ°å­¦åˆ°è¿™ä¸ªè¯ï¼ˆpagetableï¼‰æ—¶ï¼Œæˆ‘è®¤ä¸ºå®ƒè¿˜æ˜¯å¾ˆç›´è§‚ç®€å•çš„ã€‚è¿™èƒ½æœ‰å¤šéš¾å‘¢ï¼Ÿæ— éå°±æ˜¯ä¸ªè¡¨å•ï¼Œå°†è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜ å°„èµ·æ¥ï¼Œå®é™…å¯èƒ½ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä½†æ˜¯åº”è¯¥ä¸ä¼šå¤ªéš¾ã€‚å¯æ˜¯å½“æˆ‘å¼€å§‹é€šè¿‡ä»£ç ç®¡ç†è™šæ‹Ÿå†…å­˜ï¼Œæˆ‘æ‰çŸ¥é“è™šæ‹Ÿå†…å­˜æ¯”è¾ƒæ£˜æ‰‹ï¼Œæ¯”è¾ƒæœ‰è¶£ï¼ŒåŠŸèƒ½ä¹Ÿå¾ˆå¼ºå¤§ã€‚ è¿™éƒ¨åˆ†å®éªŒä¹Ÿè¯æ˜äº† pagetable ç¡®å®å¦‚æ­¤ã€‚  ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´A process">
<meta property="og:type" content="article">
<meta property="og:title" content="MIT 6.S081 Operating System Enginerring Lab Page tables">
<meta property="og:url" content="https://why41bg.github.io/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Page%20tables/">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="å¾ˆå–œæ¬¢ Frans æ•™æˆçš„å¼€åœºç™½ï¼šå½“æˆ‘è¿˜æ˜¯ä¸ªå­¦ç”Ÿå¹¶ç¬¬ä¸€æ¬¡å¬åˆ°å­¦åˆ°è¿™ä¸ªè¯ï¼ˆpagetableï¼‰æ—¶ï¼Œæˆ‘è®¤ä¸ºå®ƒè¿˜æ˜¯å¾ˆç›´è§‚ç®€å•çš„ã€‚è¿™èƒ½æœ‰å¤šéš¾å‘¢ï¼Ÿæ— éå°±æ˜¯ä¸ªè¡¨å•ï¼Œå°†è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜ å°„èµ·æ¥ï¼Œå®é™…å¯èƒ½ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä½†æ˜¯åº”è¯¥ä¸ä¼šå¤ªéš¾ã€‚å¯æ˜¯å½“æˆ‘å¼€å§‹é€šè¿‡ä»£ç ç®¡ç†è™šæ‹Ÿå†…å­˜ï¼Œæˆ‘æ‰çŸ¥é“è™šæ‹Ÿå†…å­˜æ¯”è¾ƒæ£˜æ‰‹ï¼Œæ¯”è¾ƒæœ‰è¶£ï¼ŒåŠŸèƒ½ä¹Ÿå¾ˆå¼ºå¤§ã€‚ è¿™éƒ¨åˆ†å®éªŒä¹Ÿè¯æ˜äº† pagetable ç¡®å®å¦‚æ­¤ã€‚  ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´A process">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://why41bg.github.io/blog/img/qq.png">
<meta property="article:published_time" content="2023-11-03T15:52:42.000Z">
<meta property="article:modified_time" content="2024-03-31T17:59:07.347Z">
<meta property="article:author" content="why">
<meta property="article:tag" content="XV6">
<meta property="article:tag" content="OS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://why41bg.github.io/blog/img/qq.png"><link rel="shortcut icon" href="/blog/img/favicon.png"><link rel="canonical" href="https://why41bg.github.io/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Page%20tables/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/blog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/blog/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"ç¹","msgToSimplifiedChinese":"ç°¡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'å¤©',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MIT 6.S081 Operating System Enginerring Lab Page tables',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-04-01 01:59:07'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.1.1"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/blog/img/qq.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/blog/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">14</div></a><a href="/blog/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">5</div></a><a href="/blog/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">1</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/blog/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a href="/blog/" title="Blog"><span class="site-name">Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/blog/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MIT 6.S081 Operating System Enginerring Lab Page tables</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">å‘è¡¨äº</span><time datetime="2023-11-03T15:52:42.000Z" title="å‘è¡¨äº 2023-11-03 23:52:42">2023-11-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/blog/categories/MIT-6-S081/">MIT 6.S081</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>8åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MIT 6.S081 Operating System Enginerring Lab Page tables"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>å¾ˆå–œæ¬¢ Frans æ•™æˆçš„å¼€åœºç™½ï¼šå½“æˆ‘è¿˜æ˜¯ä¸ªå­¦ç”Ÿå¹¶ç¬¬ä¸€æ¬¡å¬åˆ°å­¦åˆ°è¿™ä¸ªè¯ï¼ˆpagetableï¼‰æ—¶ï¼Œæˆ‘è®¤ä¸ºå®ƒè¿˜æ˜¯å¾ˆç›´è§‚ç®€å•çš„ã€‚è¿™èƒ½æœ‰å¤šéš¾å‘¢ï¼Ÿæ— éå°±æ˜¯ä¸ªè¡¨å•ï¼Œå°†è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜ å°„èµ·æ¥ï¼Œå®é™…å¯èƒ½ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œä½†æ˜¯åº”è¯¥ä¸ä¼šå¤ªéš¾ã€‚å¯æ˜¯å½“æˆ‘å¼€å§‹é€šè¿‡ä»£ç ç®¡ç†è™šæ‹Ÿå†…å­˜ï¼Œæˆ‘æ‰çŸ¥é“è™šæ‹Ÿå†…å­˜æ¯”è¾ƒæ£˜æ‰‹ï¼Œæ¯”è¾ƒæœ‰è¶£ï¼ŒåŠŸèƒ½ä¹Ÿå¾ˆå¼ºå¤§ã€‚</p>
<p>è¿™éƒ¨åˆ†å®éªŒä¹Ÿè¯æ˜äº† pagetable ç¡®å®å¦‚æ­¤ã€‚</p>
</blockquote>
<h1 id="ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´"><a href="#ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´" class="headerlink" title="ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´"></a>ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´</h1><p>A processâ€™s user address space, with its initial stack.</p>
<p><img src="/blog/images/%E7%94%A8%E6%88%B7%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4.png" alt="ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´"></p>
<p>è¿™æ˜¯XV6ä¸­å…³äºç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´å®šä¹‰ï¼Œåœ¨ä¸‹é¢çš„å®éªŒçš„ä¼šç”¨åˆ°ã€‚</p>
<h1 id="Speed-up-system-calls-easy"><a href="#Speed-up-system-calls-easy" class="headerlink" title="Speed up system calls (easy)"></a>Speed up system calls (<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/labs/guidance.html">easy</a>)</h1><blockquote>
<p>Some operating systems (e.g., Linux) speed up certain system calls by sharing data in a read-only region between userspace and the kernel. This eliminates the need for kernel crossings when performing these system calls. </p>
<p>æœ¬å®éªŒå°±æ˜¯é€šè¿‡é¡µè¡¨åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸é—´å…±äº«åªè¯»åŒºåŸŸçš„æ•°æ®ï¼Œè¿™æ ·å°±èƒ½åœ¨æ— éœ€åˆ‡æ¢å†…æ ¸çš„æƒ…å†µåŠ é€Ÿç³»ç»Ÿè°ƒç”¨ï¼Œå¿«é€Ÿè·å¾—ç”¨æˆ·è¿›ç¨‹çš„PIDã€‚</p>
</blockquote>
<p>æ¯ä¸ªè¿›ç¨‹åˆ›å»ºæ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªå±äºå®ƒè‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ˆé¡µè¡¨ï¼‰ï¼Œè¯¥åœ°å€ç©ºé—´çš„ç»“æ„å›¾åœ¨ä¸Šé¢ä¹Ÿç»™å‡ºæ¥äº†ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªéƒ¨åˆ†ï¼šTRAMPOLINEã€TRAPFRAMEã€USYSCALLï¼ˆå›¾ä¸­æœªç»™å‡ºï¼Œåº”è¯¥ä½äº TRAPFRAME å‰é¢ï¼‰ã€‚è€Œ USYSCALL å°±æ˜¯æ˜ å°„çš„ä¸å†…æ ¸å…±äº«çš„<strong>åªè¯»</strong>åŒºåŸŸã€‚ç”¨æˆ·è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€åœ¨ <code>kernel/memlayout.h</code> æ–‡ä»¶ä¸­ï¼Œè¿™é‡Œé¢åŒæ—¶è¿˜å®šä¹‰äº†ä¸€ä¸ª <code>usyscall</code> ç»“æ„ä½“ç”¨æ¥å­˜å‚¨ç”¨æˆ·è¿›ç¨‹çš„ PIDã€‚ç›¸å…³å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User memory layout.</span></span><br><span class="line"><span class="comment">// Address zero first:</span></span><br><span class="line"><span class="comment">//   text</span></span><br><span class="line"><span class="comment">//   original data and bss</span></span><br><span class="line"><span class="comment">//   fixed-size stack</span></span><br><span class="line"><span class="comment">//   expandable heap</span></span><br><span class="line"><span class="comment">//   ...</span></span><br><span class="line"><span class="comment">//   USYSCALL (shared with kernel)</span></span><br><span class="line"><span class="comment">//   TRAPFRAME (p-&gt;trapframe, used by the trampoline)</span></span><br><span class="line"><span class="comment">//   TRAMPOLINE (the same page as in the kernel)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRAPFRAME (TRAMPOLINE - PGSIZE)</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LAB_PGTBL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USYSCALL (TRAPFRAME - PGSIZE)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usyscall</span> &#123;</span></span><br><span class="line">  <span class="type">int</span> pid;  <span class="comment">// Process ID</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>æŒ‰ç…§æç¤ºå°±èƒ½å¤Ÿå®Œæˆè¯¥å®éªŒï¼Œè¯¦ç»†çš„æ­¥éª¤è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>åˆ›å»ºç”¨æˆ·è¿›ç¨‹çš„é¡µè¡¨ï¼Œåˆ›å»ºé¡µè¡¨çš„å‡½æ•°åœ¨ <code>kernel/proc.c</code> ä¸­ï¼Œå‡½æ•°åä¸º <code>proc_pagetable</code>ã€‚<br>ä»¿ç…§ TRAMPOLINE å’Œ TRAPFRAME çš„æ ·å­ä¸º USYSCALL åˆ†é…PTEï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pagetable_t</span></span><br><span class="line"><span class="title function_">proc_pagetable</span><span class="params">(<span class="keyword">struct</span> proc *p)</span></span><br><span class="line">&#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="comment">// map the trapframe just below TRAMPOLINE, for trampoline.S.</span></span><br><span class="line">      <span class="keyword">if</span>(mappages(pagetable, TRAPFRAME, PGSIZE,</span><br><span class="line">                  (uint64)(p-&gt;trapframe), PTE_R | PTE_W) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        uvmunmap(pagetable, TRAMPOLINE, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        uvmfree(pagetable, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// map the USYSCALL just below trapframe</span></span><br><span class="line">      <span class="keyword">if</span>(mappages(pagetable, USYSCALL, PGSIZE, </span><br><span class="line">                  (uint64)(p-&gt;usyscall), PTE_R | PTE_U) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        uvmunmap(pagetable, TRAMPOLINE, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        uvmunmap(pagetable, TRAPFRAME, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        uvmfree(pagetable, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> pagetable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>ä¸ºç”¨æˆ·è¿›ç¨‹åˆ†é…å®é™…çš„ç‰©ç†å†…å­˜ï¼ŒåŒæ—¶åˆå§‹åŒ–ã€‚ç›¸å…³å‡½æ•°ä¸º <code>kernel/proc.c</code> ä¸­çš„ <code>allocproc</code>ã€‚<br>ä»¿ç…§ä¸º TRAPFRAME åˆ†é…å†…å­˜çš„æ–¹å¼ä¸º USYSCALL åˆ†é…å®é™…çš„ç‰©ç†å†…å­˜ï¼Œ<strong>ä¸è¦å¿˜è®°å¯¹ <code>USYSCALL</code> åˆå§‹åŒ–</strong>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> proc*</span><br><span class="line"><span class="title function_">allocproc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// Allocate a trapframe page.</span></span><br><span class="line">    <span class="keyword">if</span>((p-&gt;trapframe = (<span class="keyword">struct</span> trapframe *)kalloc()) == <span class="number">0</span>)&#123;</span><br><span class="line">      freeproc(p);</span><br><span class="line">      release(&amp;p-&gt;lock);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allocate a usyscall page.</span></span><br><span class="line">    <span class="keyword">if</span>((p-&gt;usyscall = (<span class="keyword">struct</span> usyscall *)kalloc()) == <span class="number">0</span>)&#123;</span><br><span class="line">      freeproc(p);</span><br><span class="line">      release(&amp;p-&gt;lock);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    p-&gt;usyscall-&gt;pid = p-&gt;pid;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>å®Œå–„ <code>kernel/proc.c</code> ä¸­ä¸é‡Šæ”¾ç‰©ç†å†…å­˜æœ‰å…³çš„å‡½æ•° <code>freeproc</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">freeproc</span><span class="params">(<span class="keyword">struct</span> proc *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span>(p-&gt;usyscall)</span><br><span class="line">    	kfree((<span class="type">void</span>*)p-&gt;usyscall);</span><br><span class="line">  	p-&gt;usyscall = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>å®Œå–„ <code>kernel/proc.c</code> ä¸­é‡Šæ”¾é¡µè¡¨æœ‰å…³çš„å‡½æ•° <code>proc_freepagetable</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">proc_freepagetable</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 sz)</span></span><br><span class="line">&#123;</span><br><span class="line">  uvmunmap(pagetable, TRAMPOLINE, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  uvmunmap(pagetable, TRAPFRAME, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  uvmunmap(pagetable, USYSCALL, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  uvmfree(pagetable, sz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>è¯¥å®éªŒæœ€åè¿˜æå‡ºäº†ä¸€ä¸ªé—®é¢˜ï¼Œ<strong>Which other xv6 system call(s) could be made faster using this shared page?</strong> ç­”æ¡ˆæ˜¯ï¼šfork ç³»ç»Ÿè°ƒç”¨ã€‚åªéœ€è¦åœ¨ <code>usyscall</code> ç»“æ„ä½“ä¸­åŠ å…¥çˆ¶è¿›ç¨‹çš„ <code>parent</code> ç»“æ„ä½“ï¼Œå³å¯åœ¨ fork ç³»ç»Ÿè°ƒç”¨å¤åˆ¶çˆ¶è¿›ç¨‹å†…å­˜ç©ºé—´æ—¶ï¼Œæ— éœ€åˆ‡æ¢åˆ°å†…æ ¸å³å¯æ‰¾åˆ°çˆ¶è¿›ç¨‹å®é™…çš„ç‰©ç†å†…å­˜åœ°å€ï¼Œä»è€Œå®Œæˆçˆ¶è¿›ç¨‹å†…å­˜ç©ºé—´çš„å¤åˆ¶ã€‚</p>
<h1 id="Print-a-page-table-easy"><a href="#Print-a-page-table-easy" class="headerlink" title="Print a page table (easy)"></a>Print a page table (<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/labs/guidance.html">easy</a>)</h1><blockquote>
<p>æ­¤å®éªŒè¦æ±‚æ‰“å°ä¸€ä¸ªè¿›ç¨‹çš„é¡µè¡¨ï¼Œç›®çš„åœ¨äºå¸®åŠ©æˆ‘ä»¬ç†è§£XV6ä¸­ä¸‰çº§é¡µè¡¨çš„ç»“æ„ã€‚</p>
</blockquote>
<p>ä»»åŠ¡è¦æ±‚å¦‚ä¸‹ï¼šåœ¨ <code>kernel/vm.c</code> ä¸­å®šä¹‰ä¸€ä¸ª  <code>vmprint</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ª <code>pagetable_t</code>  å‚æ•°ï¼Œç„¶åæ ¼å¼åŒ–è¾“å‡ºè¯¥é¡µè¡¨çš„å†…å®¹ã€‚</p>
<p>æœ‰ä¸€ç‚¹æç¤ºå¾ˆå…³é”®ï¼š<strong>The function <code>freewalk</code> may be inspirational.</strong> <code>kernel/vm.c</code> ä¸­çš„ <code>freewalk</code> å‡½æ•°é€šè¿‡é€’å½’çš„æ–¹å¼å¯¹è¿›ç¨‹é¡µè¡¨è¿›è¡Œäº†å¤„ç†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒè¿™ä¸ªå‡½æ•°å®ç°æ¥ <code>vmprint</code>ã€‚</p>
<p>å…·ä½“çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>åœ¨ <code>kernel/vm.c</code> ä¸­å®ç°  <code>vmprint</code> å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">char</span>* prefix[<span class="number">3</span>] = &#123;<span class="string">&quot;..&quot;</span>, <span class="string">&quot;.. ..&quot;</span>, <span class="string">&quot;.. .. ..&quot;</span>&#125;;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Cycle through the contents of a page table</span></span><br><span class="line"><span class="comment">// Reference freewalk() function</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">vmprint</span><span class="params">(<span class="type">pagetable_t</span> pgtbl)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;page table %p\n&quot;</span>, pgtbl);</span><br><span class="line">  <span class="comment">// Entry recursion to print pgtbl</span></span><br><span class="line">  vmprint_re(pgtbl, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">vmprint_re</span><span class="params">(<span class="type">pagetable_t</span> pgtbl, <span class="type">int</span> layer)</span>&#123;</span><br><span class="line">  <span class="comment">// End condition</span></span><br><span class="line">  <span class="keyword">if</span>(layer &gt; <span class="number">2</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// There are 2^9 = 512 PTEs in a page table.</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">512</span>; i++)&#123;</span><br><span class="line">    <span class="type">pte_t</span> pte = pgtbl[i];</span><br><span class="line">    <span class="keyword">if</span>((pte &amp; PTE_V))&#123;</span><br><span class="line">      uint64 pa = PTE2PA(pte);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%s%d: pte %p pa %p\n&quot;</span>, prefix[layer], i, pte, pa);</span><br><span class="line">      vmprint_re((<span class="type">pagetable_t</span>)pa, layer+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>åœ¨ <code>kernel/defs.h</code> ä¸­å£°æ˜  <code>vmprint</code> å‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vm.c</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="type">int</span>             <span class="title function_">copyinstr</span><span class="params">(<span class="type">pagetable_t</span>, <span class="type">char</span> *, uint64, uint64)</span>;</span><br><span class="line"><span class="type">void</span>            <span class="title function_">vmprint</span><span class="params">(<span class="type">pagetable_t</span>)</span>;</span><br><span class="line"><span class="type">void</span>            <span class="title function_">vmprint_re</span><span class="params">(<span class="type">pagetable_t</span>, <span class="type">int</span>)</span>;</span><br></pre></td></tr></table></figure>


</li>
<li><p>åœ¨ <code>kernel/exec.c</code> ä¸­çš„ <code>exec</code> å‡½æ•°ç»“æŸå‰ï¼Œè°ƒç”¨ <code>vmprint</code> å‡½æ•°æ‰“å°è¿›ç¨‹çš„é¡µè¡¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">exec</span><span class="params">(<span class="type">char</span> *path, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Print the page table before the end of the exec</span></span><br><span class="line">  	vmprint(p-&gt;pagetable);</span><br><span class="line">  	<span class="keyword">return</span> argc; <span class="comment">// this ends up in a0, the first argument to main(argc, argv)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="Detecting-which-pages-have-been-accessed-hard"><a href="#Detecting-which-pages-have-been-accessed-hard" class="headerlink" title="Detecting which pages have been accessed (hard)"></a>Detecting which pages have been accessed (<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2021/labs/guidance.html">hard</a>)</h1><blockquote>
<p>Some garbage collectors (a form of automatic memory management) can benefit from information about which pages have been accessed (read or write). In this part of the lab, you will add a new feature to xv6 that detects and reports this information to userspace by inspecting the access bits in the RISC-V page table. The RISC-V hardware page walker marks these bits in the PTE whenever it resolves a TLB miss.</p>
<p>è¿™ä¸ªå®éªŒçœ‹ä¼¼å¾ˆéš¾ï¼Œå…¶å®è¿˜å¥½ã€‚éœ€è¦å®ç°ä¸€ä¸ªå†…æ ¸ç¨‹åºï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œæ‰«æé¡µè¡¨ä¸­å“ªäº›é¡µè¡¨é¡¹çš„æ ‡å¿—ä½ PTE_A è¢«æ ‡è®°ä¸ºäº†1ã€‚</p>
</blockquote>
<p>åœ¨æµ‹è¯•ç¨‹åºçš„ä»£ç ä¸­ï¼Œå°±ä¸ºæˆ‘ä»¬åˆå§‹åŒ–äº†ä¸€ä¸ªé¡µè¡¨ï¼Œå¹¶å°†å…¶ä¸­æŸäº›PTEçš„æ ‡å¿—ä½ PTE_A æ ‡è®°ä¸ºäº†1ã€‚æµ‹è¯•ä¾‹ç¨‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">pgaccess_test</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *buf;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> abits;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;pgaccess_test starting\n&quot;</span>);</span><br><span class="line">  testname = <span class="string">&quot;pgaccess_test&quot;</span>;</span><br><span class="line">  buf = <span class="built_in">malloc</span>(<span class="number">32</span> * PGSIZE);</span><br><span class="line">  <span class="keyword">if</span> (pgaccess(buf, <span class="number">32</span>, &amp;abits) &lt; <span class="number">0</span>)</span><br><span class="line">    err(<span class="string">&quot;pgaccess failed&quot;</span>);</span><br><span class="line">  buf[PGSIZE * <span class="number">1</span>] += <span class="number">1</span>;</span><br><span class="line">  buf[PGSIZE * <span class="number">2</span>] += <span class="number">1</span>;</span><br><span class="line">  buf[PGSIZE * <span class="number">30</span>] += <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (pgaccess(buf, <span class="number">32</span>, &amp;abits) &lt; <span class="number">0</span>)</span><br><span class="line">    err(<span class="string">&quot;pgaccess failed&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (abits != ((<span class="number">1</span> &lt;&lt; <span class="number">1</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">2</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">30</span>)))</span><br><span class="line">    err(<span class="string">&quot;incorrect access bits set&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(buf);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;pgaccess_test: OK\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆ PTE_A åœ¨ PTE çš„å“ªä¸ªä½ç½®å‘¢ï¼Ÿåœ¨ PTE ä»å³åˆ°å·¦ç¬¬ 7 ä¸ªï¼ˆindex ä¸º 6ï¼‰æ¯”ç‰¹ä½ï¼Œæç¤ºä¸­ä¹Ÿè¯´æ˜äº†éœ€è¦åœ¨ <code>kernel/riscv.h</code> ä¸­è®¾ç½®å®å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_U (1L <span class="string">&lt;&lt; 4) // 1 -&gt;</span> user can access</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_A (1L <span class="string">&lt;&lt; 6) // 1 -&gt;</span> page has been accessed</span></span><br></pre></td></tr></table></figure>

<p>å¦‚ä½•æ‰¾åˆ°è™šæ‹Ÿåœ°å€å¯¹åº”çš„æœ€åä¸€çº§ PTE å‘¢ï¼Ÿå…³é”®å°±æ˜¯ <code>walk</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°å¯ä»¥æ ¹æ®è™šæ‹Ÿåœ°å€æ‰¾åˆ°å¯¹åº”çš„ PTEã€‚å› æ­¤ï¼Œæ•´ä¸ªæµç¨‹å°±åº”è¯¥ä¸ºï¼š</p>
<ol>
<li>è§£æç”¨æˆ·ç¨‹åºå‚æ•°ï¼Œè·å¾—åˆå§‹è™šæ‹Ÿåœ°å€ï¼Œæ‰«æé¡µè¡¨çš„ä¸Šé™ï¼Œä¸€ä¸ªç”¨æˆ·ç©ºé—´çš„ç¼“å­˜åŒºï¼ˆstore the results into a bitmaskï¼‰ã€‚</li>
<li>ä»åˆå§‹åœ°å€å¼€å§‹æ£€æµ‹ï¼Œé€šè¿‡ <code>walk</code> å‡½æ•°è·å¾—å…¶å¯¹åº” PTEã€‚å¦‚æœ PTE_A ä¸º1ï¼Œåˆ™å°†å†…æ ¸ç¼“å†²åŒºä¸­çš„ bitmask å¯¹åº”ä½ç½®è®¾ç½®ä¸º1ï¼Œç„¶åæ¸…ç©º PTEä¸­çš„ PTE_Aã€‚</li>
<li>å¾ªç¯ç¬¬2æ­¥è‡³ä¸Šé™ã€‚</li>
<li>åˆ©ç”¨ <code>copyout</code> å‡½æ•°å°†å†…æ ¸ç©ºé—´çš„ç¼“å†²åŒºå¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´ã€‚</li>
</ol>
<p>å› æ­¤ï¼Œ<code>sys_pgaccess</code> å‡½æ•°çš„å®Œæ•´å®ç°ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LAB_PGTBL</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">sys_pgaccess</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// lab pgtbl: your code here.</span></span><br><span class="line">  uint64 va;  <span class="comment">// The starting virtual address of the first user page to check.</span></span><br><span class="line">  <span class="type">int</span> pgnum;  <span class="comment">// The number of pages to check</span></span><br><span class="line">  uint64 bitmask;  <span class="comment">// Use one bit per page</span></span><br><span class="line">  <span class="keyword">if</span>(argaddr(<span class="number">0</span>, &amp;va) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(argint(<span class="number">1</span>, &amp;pgnum) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(argaddr(<span class="number">2</span>, &amp;bitmask) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(pgnum &gt; <span class="number">64</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  uint64 kbuf = <span class="number">0</span>; <span class="comment">// Kernel buffer</span></span><br><span class="line">  <span class="type">pte_t</span> *pte;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; pgnum; i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>(va &gt; MAXVA)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    pte = walk(p-&gt;pagetable, va, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(pte == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(*pte &amp; PTE_A)&#123;</span><br><span class="line">      kbuf |= (<span class="number">1</span> &lt;&lt; i);  <span class="comment">// Set the page bit in kernel buffer</span></span><br><span class="line">      *pte &amp;= (~PTE_A);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    va += PGSIZE;  <span class="comment">// To the next page</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(copyout(p-&gt;pagetable, bitmask, (<span class="type">char</span>*)&amp;kbuf, <span class="keyword">sizeof</span>(kbuf)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>æœ€åè¿˜æœ‰ä¸€ä¸ªå¾ˆå…³é”®çš„ç‚¹ï¼Œä½†æç¤ºä¸­æ²¡æœ‰è¯´ï¼š<strong>åœ¨ <code>kernel/defs.h</code> ä¸­å£°æ˜ä¸€ä¸‹ <code>walk</code> å‡½æ•°</strong>ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡æœ‰å£°æ˜ã€‚ã€‚ğŸ¥´ğŸ¥´</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://why41bg.github.io/blog">why</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://why41bg.github.io/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Page%20tables/">https://why41bg.github.io/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Page%20tables/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://why41bg.github.io/blog" target="_blank">Blog</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/blog/tags/XV6/">XV6</a><a class="post-meta__tags" href="/blog/tags/OS/">OS</a></div><div class="post_share"><div class="social-share" data-image="/blog/img/qq.png" data-sites="wechat,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Traps/" title="MIT 6.S081 Operating System Enginerring Lab Traps"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">MIT 6.S081 Operating System Enginerring Lab Traps</div></div></a></div><div class="next-post pull-right"><a href="/blog/%E9%A1%B5%E8%A1%A8%E7%9A%84%E6%9C%BA%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/" title="é¡µè¡¨çš„æœºç†åŠå®ç°"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">é¡µè¡¨çš„æœºç†åŠå®ç°</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Copy%20on%20write/" title="MIT 6.S081 Operating System Enginerring Lab Copy on write"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-26</div><div class="title">MIT 6.S081 Operating System Enginerring Lab Copy on write</div></div></a></div><div><a href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20File%20system/" title="MIT 6.S081 Operating System Enginerring Lab File system"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-30</div><div class="title">MIT 6.S081 Operating System Enginerring Lab File system</div></div></a></div><div><a href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Multithreading/" title="MIT 6.S081 Operating System Enginerring Lab Multithreading"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-28</div><div class="title">MIT 6.S081 Operating System Enginerring Lab Multithreading</div></div></a></div><div><a href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20System%20calls/" title="MIT 6.S081 Operating System Enginerring Lab System calls"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-22</div><div class="title">MIT 6.S081 Operating System Enginerring Lab System calls</div></div></a></div><div><a href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Traps/" title="MIT 6.S081 Operating System Enginerring Lab Traps"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-07</div><div class="title">MIT 6.S081 Operating System Enginerring Lab Traps</div></div></a></div><div><a href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Utilities/" title="MIT 6.S081 Operating System Enginerring Lab Utilities"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-10</div><div class="title">MIT 6.S081 Operating System Enginerring Lab Utilities</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/blog/img/qq.png" onerror="this.onerror=null;this.src='/blog/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">why</div><div class="author-info__description">ä¸å¦‚åƒèŒ¶å»</div></div><div class="card-info-data site-data is-center"><a href="/blog/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">14</div></a><a href="/blog/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">5</div></a><a href="/blog/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/why41bg"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">æš‚æ— å…¬å‘Š</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="toc-number">1.</span> <span class="toc-text">ç”¨æˆ·è¿›ç¨‹çš„åœ°å€ç©ºé—´</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Speed-up-system-calls-easy"><span class="toc-number">2.</span> <span class="toc-text">Speed up system calls (easy)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Print-a-page-table-easy"><span class="toc-number">3.</span> <span class="toc-text">Print a page table (easy)</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Detecting-which-pages-have-been-accessed-hard"><span class="toc-number">4.</span> <span class="toc-text">Detecting which pages have been accessed (hard)</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" title="Javaè®¾è®¡æ¨¡å¼ä¹‹å•ä¾‹æ¨¡å¼">Javaè®¾è®¡æ¨¡å¼ä¹‹å•ä¾‹æ¨¡å¼</a><time datetime="2024-03-31T16:17:23.000Z" title="å‘è¡¨äº 2024-04-01 00:17:23">2024-04-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20File%20system/" title="MIT 6.S081 Operating System Enginerring Lab File system">MIT 6.S081 Operating System Enginerring Lab File system</a><time datetime="2023-11-30T11:40:40.000Z" title="å‘è¡¨äº 2023-11-30 19:40:40">2023-11-30</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Multithreading/" title="MIT 6.S081 Operating System Enginerring Lab Multithreading">MIT 6.S081 Operating System Enginerring Lab Multithreading</a><time datetime="2023-11-28T01:37:18.000Z" title="å‘è¡¨äº 2023-11-28 09:37:18">2023-11-28</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Copy%20on%20write/" title="MIT 6.S081 Operating System Enginerring Lab Copy on write">MIT 6.S081 Operating System Enginerring Lab Copy on write</a><time datetime="2023-11-26T13:37:01.000Z" title="å‘è¡¨äº 2023-11-26 21:37:01">2023-11-26</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/xv6%E4%B8%ADtrap%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%EF%BC%88%E4%BA%8C%EF%BC%89/" title="xv6ä¸­trapçš„æ‰§è¡Œæµï¼ˆäºŒï¼‰">xv6ä¸­trapçš„æ‰§è¡Œæµï¼ˆäºŒï¼‰</a><time datetime="2023-11-09T13:25:29.000Z" title="å‘è¡¨äº 2023-11-09 21:25:29">2023-11-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By why</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Good luck && Have fun</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/blog/js/utils.js"></script><script src="/blog/js/main.js"></script><script src="/blog/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="å¯Œå¼º,æ°‘ä¸»,æ–‡æ˜,å’Œè°,è‡ªç”±,å¹³ç­‰,å…¬æ­£,æ³•åˆ¶,çˆ±å›½,æ•¬ä¸š,è¯šä¿¡,å‹å–„" data-fontsize="15px" data-random="true" async="async"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>