<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Blog</title><meta name="author" content="why"><meta name="copyright" content="why"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="不如吃茶去">
<meta property="og:type" content="website">
<meta property="og:title" content="Blog">
<meta property="og:url" content="https://why41bg.github.io/blog/page/2/">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="不如吃茶去">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://why41bg.github.io/blog/img/qq.png">
<meta property="article:author" content="why">
<meta property="article:tag" content="why">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://why41bg.github.io/blog/img/qq.png"><link rel="shortcut icon" href="/blog/img/favicon.png"><link rel="canonical" href="https://why41bg.github.io/blog/page/2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/blog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/blog/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Blog',
  isPost: false,
  isHome: true,
  isHighlightShrink: true,
  isToc: false,
  postUpdate: '2024-04-23 16:01:08'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.2.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/blog/img/qq.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/blog/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/blog/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/blog/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="page" id="body-wrap"><header class="full_page" id="page-header"><nav id="nav"><span id="blog-info"><a href="/blog/" title="Blog"><span class="site-name">Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/blog/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/blog/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/blog/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/blog/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="site-info"><h1 id="site-title">Blog</h1><div id="site-subtitle"><span id="subtitle"></span></div></div><div id="scroll-down"><i class="fas fa-angle-down scroll-down-effects"></i></div></header><main class="layout" id="content-inner"><div class="recent-posts" id="recent-posts"><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/blog/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/" title="Java设计模式之策略模式">Java设计模式之策略模式</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-04-01T03:56:49.000Z" title="发表于 2024-04-01 11:56:49">2024-04-01</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/blog/categories/GoF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">GoF设计模式</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/blog/tags/java/">java</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/blog/tags/GoF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">GoF设计模式</a></span></div><div class="content">策略模式设计思想策略设计模式是行为型设计模式之一。当我们为特定任务设计了多种算法，让客户端在运行时决定实际使用的算法时，就可以使用策略模式，让客户端将使用的算法作为参数传递。策略模式的一个最直观的示例就是 Collections.sort() 方法，这个方法接收一个 Comparator 参数，根据这个接口具体的实现来在运行时决定实际采用的排序算法。
策略模式和状态模式非常相似，它们之间的主要区别在于：在状态模式下，上下文中使用了变量来存储状态，外部的任务实现依靠这些内部状态。而在策略模式下，上下文中并不存储策略，而是将策略作为参数，由外部调用者在运行时传入。
Demo接下来采用一个购物车的 demo 来演示策略模式的具体应用。假设有一个购物车，购物车中有多个商品，还提供了一个支付的功能，用于一次性支付购物车中的商品，在支付的时候可以采用两种支付方式，信用卡支付或者 paypal 支付，具体使用哪种支付方式由用户决定。
因此，首先定义一个支付策略的接口，所有的支付实现类都需要实现这个接口，接口如下：
IPayMethod
123public interface IPayMethod & ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/blog/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F/" title="Java设计模式之工厂模式">Java设计模式之工厂模式</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-03-31T18:10:25.000Z" title="发表于 2024-04-01 02:10:25">2024-04-01</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/blog/categories/GoF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">GoF设计模式</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/blog/tags/java/">java</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/blog/tags/GoF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">GoF设计模式</a></span></div><div class="content">工厂模式设计思想工厂模式是一种创建型设计模式，提供了一种针对接口，而不是实现的编码方式。工厂模式的核心目的在于将对象的实例化过程与对象的使用解耦，将实际实现类的实例化从应用程序代码中移除。在工厂模式下，客户端代码只需要关心对象的接口，而无需关心具体的实例化过程，从而实现了解耦。
工厂模式通常的实现方式是通过提供一个创建对象的接口，让客户端在运行的过程中自己决定实例化哪一个工厂类（在工厂中创建并返回的类），工厂模式使工厂类的创建延迟到了客户端运行时。
DemoDemo 的背景是模拟各种奖品的发放，这里暂时有三种奖品，分别是优惠券，实物商品和第三方爱奇艺会员兑换卡。如果不设计一个接口来统一这些奖品的发放，那么就有可能因为程序员的不同而导致出现各种各样的商品接口，例如下面这张表：



序号
类型
接口



1
优惠券
CouponResult sendCoupon(String uId, String couponNumber, String uuid)


2
实物商品
Boolean deliverGoods(DeliverReq req)


3
第三方爱奇艺会员兑换卡
void  ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/blog/Java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" title="Java设计模式之单例模式">Java设计模式之单例模式</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2024-03-31T16:05:23.000Z" title="发表于 2024-04-01 00:05:23">2024-04-01</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/blog/categories/GoF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">GoF设计模式</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/blog/tags/java/">java</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/blog/tags/GoF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">GoF设计模式</a></span></div><div class="content">单例模式单例模式如同它的名字一样，限制了采用单例模式的类在 JVM 中只能有一个实例对象存在。常用于日志，驱动对象，缓存和线程池。单例模式属于 GoF 中提出的创建型，结构型和行为型中的创建型。
单例类需要满足三个要求，分别是：

私有化构造方法，防止其他类实例化单例类；

单例类的私有静态变量，是该类的唯一实例；

提供一个公共的静态方法来返回该类的实例，这是外部获取单例类实例的全局访问点。


下面逐一说明单例模式的8种实现。
一. 饿汉式初始化使用 Eager 实现，单例类的实例在类加载的时候就初始化了（类变量，与类加载的知识有关）。这种方式的缺点是，即使应用程序没有使用它，它也会被创建。下面是 demo：
123456789public class EagerInitSingleton &#123;  private static EagerInitSingleton instance = new EagerInitSingleton();  private EagerInitSingleton() &#123;&#125;  public static EagerInitSi ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20File%20system/" title="MIT 6.S081 Operating System Enginerring Lab File system">MIT 6.S081 Operating System Enginerring Lab File system</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-11-30T11:40:40.000Z" title="发表于 2023-11-30 19:40:40">2023-11-30</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/blog/categories/MIT-6-S081/">MIT 6.S081</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/blog/tags/XV6/">XV6</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/blog/tags/OS/">OS</a></span></div><div class="content">Large files (moderate)
这个实验比较简单，就是扩展一下单个文件的最大存储空间，实现思路和多级页表很类似，甚至可以说比多级页表更简单。

首先修改 fs.h 文件。
12345678910111213#define NDIRECT 11#define NINDIRECT (BSIZE / sizeof(uint))#define MAXFILE (NDIRECT + NINDIRECT + NINDIRECT * NINDIRECT)// On-disk inode structurestruct dinode &#123;  short type;           // File type  short major;          // Major device number (T_DEVICE only)  short minor;          // Minor device number (T_DEVICE only)  short nlink;          // Number of links to inode in file syste ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Multithreading/" title="MIT 6.S081 Operating System Enginerring Lab Multithreading">MIT 6.S081 Operating System Enginerring Lab Multithreading</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-11-28T01:37:18.000Z" title="发表于 2023-11-28 09:37:18">2023-11-28</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/blog/categories/MIT-6-S081/">MIT 6.S081</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/blog/tags/XV6/">XV6</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/blog/tags/OS/">OS</a></span></div><div class="content">
This lab will familiarize you with multithreading. You will implement switching between threads in a user-level threads package, use multiple threads to speed up a program, and implement a barrier.说实话，翻译文档看起来挺混乱的，导致我长时间迷失在了线程切换的复杂的函数调用中。直到我在b站上找到了翻译视频，实际观察到了在线程切换时的函数调用过程，我觉得将视频和翻译文档结合起来，对函数的调用过程才会更加明晰。

Uthread: switching between threads (moderate)
In this exercise you will design the context switch mechanism for a user-level threading system, and then implement it. 
这个实验是完成用户级线程的切换（注意区分用户级线程和内 ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Copy%20on%20write/" title="MIT 6.S081 Operating System Enginerring Lab Copy on write">MIT 6.S081 Operating System Enginerring Lab Copy on write</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-11-26T13:37:01.000Z" title="发表于 2023-11-26 21:37:01">2023-11-26</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/blog/categories/MIT-6-S081/">MIT 6.S081</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/blog/tags/XV6/">XV6</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/blog/tags/OS/">OS</a></span></div><div class="content">Copy on write 机制介绍当 shell 执行一个用户程序时，shell 在背后做了一系列的操作。首先使用 fork 系统调用拷贝一份 shell 的内存空间，然后使用 exec 系统调用，将需要执行的用户进程的指令、数据等替换新拷贝的内存空间。在这个过程中，如果 fork 拷贝的父进程的内存空间很大（在 xv6 中，shell 的内存空间一般是4个 page），那么将花费大量时间，这部分时间实际上来说就是被浪费了的。
Copy on write 做的事情实际上就是在执行 fork 系统调用的时候不会拷贝父进程的内存空间，而是将父进程的物理内存地址映射到子进程的 page table 中，并将父进程与子进程的 page table 中的 PTE 的写标志位置为0，表明不能对这部分物理内存进行写操作。当父进程或子进程对这部分内存进行写操作时，则会触发一个 page fault。
当处理这个 page fault 时，再为这个虚拟地址分配实际的物理内存，将原来物理内存中的内容拷贝过去，然后将这个新分配的物理内存映射到 page table 中，并修改响应的标志位。当完成这一切后， ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/blog/xv6%E4%B8%ADtrap%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%EF%BC%88%E4%BA%8C%EF%BC%89/" title="xv6中trap的执行流（二）">xv6中trap的执行流（二）</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-11-09T13:25:29.000Z" title="发表于 2023-11-09 21:25:29">2023-11-09</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/blog/tags/XV6/">XV6</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/blog/tags/OS/">OS</a></span></div><div class="content">uservec函数回到 XV6 和 RISC-V，现在程序位于 trampoline page 的起始，也是 uservec 函数的起始。我们现在需要做的第一件事情就是保存寄存器的内容。在 RISC-V 上，如果不能使用寄存器，基本上不能做任何事情。所以，对于保存这些寄存器，我们有什么样的选择呢？
在一些其他的机器中，我们或许直接就将32个寄存器中的内容写到物理内存中某些合适的位置。但是我们不能在 RISC-V 中这样做，因为在 RISC-V 中，supervisor mode 下的代码不允许直接访问物理内存。所以我们只能使用 page table 中的内容，但是从前面的输出来看，page table 中也没有多少内容。
虽然 XV6 并没有使用，但是另一种可能的操作是，直接将 SATP 寄存器指向 kernel page table，之后我们就可以直接使用所有的 kernel mapping 来帮助我们存储用户寄存器。这是合法的，因为supervisor mode 可以更改 SATP 寄存器。但是在 trap 代码当前的位置，也就是 trap 机制的最开始，我们并不知道 kernel ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/blog/xv6%E4%B8%ADtrap%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%EF%BC%88%E4%B8%80%EF%BC%89/" title="xv6中trap的执行流（一）">xv6中trap的执行流（一）</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-11-09T05:48:36.000Z" title="发表于 2023-11-09 13:48:36">2023-11-09</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/blog/tags/XV6/">XV6</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/blog/tags/OS/">OS</a></span></div><div class="content">
关于 xv6 中 trap 机制的实现及执行流程，Robert 教授讲得实在是太好了，让我实在不忍心用自己的话记录关于这一节课知识的理解，以防出现任何违背了 Robert 教授原本意愿的地方。因此，本文中记录的绝大多数都是 Robert 教授原话的翻译，只在些许小地方加入了作者自己理解，特别感谢翻译者准确用心的翻译。

Trap的执行流程当在 shell 中使用 write 系统调用时，操作系统将从用户态转变为内核态，从而请求内核提供服务。实际上，write 通过执行 ecall 指令来请求系统调用，ecall 指令会切换到具有 supervisor mode 的内核中，这里涉及到的其实就是系统调用方面的知识了。write 的本质其实就是通过 Trap（陷入），用户程序主动将处理器控制权交给操作系统，由操作系统内核提供需要的服务，然后操作系统再将控制权还给用户程序，下图是 write 系统调用的执行流程。

ECALL指令执行前的状态接下来，Robert 带我们进入了 gdb 的世界中，通过跟踪一个 XV6 的系统调用，来演示上述 Trap 的执行流。我们跟踪的这个系统调用，也就是  ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/blog/%E4%BB%A5x86%E5%88%86%E6%9E%90%E6%A0%88%E5%B8%A7%E7%9A%84%E5%88%87%E6%8D%A2%E8%BF%87%E7%A8%8B/" title="以x86分析栈帧的切换过程">以x86分析栈帧的切换过程</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-11-08T13:13:34.000Z" title="发表于 2023-11-08 21:13:34">2023-11-08</time></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/blog/tags/XV6/">XV6</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/blog/tags/OS/">OS</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/blog/tags/Stack-Frame/">Stack Frame</a></span></div><div class="content">
最近在学习MIT6.S018时，对栈帧的理解及切换过程的学习遇到了困难。在网上找了很多资料，最终看到了一个视频，以x86为基础分析了栈帧的切换过程。遂写下此文记录一下自己的理解，并举一反三，理解XV6中的栈帧结构及其切换过程。

XV6中栈结构下图是XV6中栈的简单结构图，其中每一个区域都是一个 Stack Frame（栈帧），每执行一次函数调用就会产生一个Stack Frame。

x86中栈结构x86中函数调用栈在内存中的位置如下图所示。通常来说，栈的最上面（栈底）为高地址，最下面（栈顶）为低地址，这样规定是因为与内存的结构有关。

x86中栈的切换下面给出一段执行函数调用的汇编代码，然后根据这段汇编代码来分析栈帧创建及其销毁的完整流程，并将x86中栈帧的创建与XV6中的栈帧结构图作对比，我们将发现其基本一致。下面给出两个函数的汇编代码，分别是 caller 函数和 add 函数，在 caller 函数中将调用 add 函数。
123456789101112131415caller:push ebpmov ebp,espsub esp,24mov [ebp-12],125mov  ...</div></div></div><div class="recent-post-item"><div class="recent-post-info no-cover"><a class="article-title" href="/blog/MIT%206.S081%20Operating%20System%20Enginerring%20Lab%20Traps/" title="MIT 6.S081 Operating System Enginerring Lab Traps">MIT 6.S081 Operating System Enginerring Lab Traps</a><div class="article-meta-wrap"><span class="post-meta-date"><i class="far fa-calendar-alt"></i><span class="article-meta-label">发表于</span><time datetime="2023-11-07T09:09:23.000Z" title="发表于 2023-11-07 17:09:23">2023-11-07</time></span><span class="article-meta"><span class="article-meta-separator">|</span><i class="fas fa-inbox"></i><a class="article-meta__categories" href="/blog/categories/MIT-6-S081/">MIT 6.S081</a></span><span class="article-meta tags"><span class="article-meta-separator">|</span><i class="fas fa-tag"></i><a class="article-meta__tags" href="/blog/tags/XV6/">XV6</a><span class="article-meta-link">•</span><a class="article-meta__tags" href="/blog/tags/OS/">OS</a></span></div><div class="content">
This lab explores how system calls are implemented using traps. 

RISC-V assembly (easy)
对于这个实验内容，关键在于理解 RISC-V 汇编

首先要运行下面的指令生成 user/call.asm 文件，需要重点关注其中的 g、f 和 main 三个函数，然后回答下面五个问题。
1make fs.img

Q1：Which registers contain arguments to functions? For example, which register holds 13 in main’s call to printf ?
user/call.ams 文件中关于 main 函数如下：
12345678910111213141516void main(void) &#123;  1c:	1141                	addi	sp,sp,-16  1e:	e406                	sd	ra,8(sp)  20:	e022                	sd	s ...</div></div></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/blog/"><i class="fas fa-chevron-left fa-fw"></i></a><a class="page-number" href="/blog/">1</a><span class="page-number current">2</span><a class="page-number" href="/blog/page/3/#content-inner">3</a><a class="extend next" rel="next" href="/blog/page/3/#content-inner"><i class="fas fa-chevron-right fa-fw"></i></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/blog/img/qq.png" onerror="this.onerror=null;this.src='/blog/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">why</div><div class="author-info__description">不如吃茶去</div></div><div class="card-info-data site-data is-center"><a href="/blog/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/blog/tags/"><div class="headline">标签</div><div class="length-num">19</div></a><a href="/blog/categories/"><div class="headline">分类</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/why41bg"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">社会的边角料，妈妈的小骄傲</div></div><div class="sticky_layout"><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/%E5%BB%BA%E5%9B%BE%E6%96%B9%E6%B3%95%EF%BC%9A%E6%A0%B9%E6%8D%AE%E6%A0%91%E5%BB%BA%E5%9B%BE/" title="建图方法：根据树建图">建图方法：根据树建图</a><time datetime="2024-04-23T06:31:08.000Z" title="发表于 2024-04-23 14:31:08">2024-04-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/%E5%9B%BE%E8%AE%BA%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F/" title="图论拓扑排序">图论拓扑排序</a><time datetime="2024-04-21T15:38:02.000Z" title="发表于 2024-04-21 23:38:02">2024-04-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/%E6%97%A0%E5%90%91%E5%9B%BE%E8%AE%A1%E7%AE%97%E8%BF%9E%E9%80%9A%E5%88%86%E9%87%8F/" title="无向图计算连通分量">无向图计算连通分量</a><time datetime="2024-04-20T16:38:34.000Z" title="发表于 2024-04-21 00:38:34">2024-04-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E4%B8%93%E9%A2%98/" title="二分查找专题">二分查找专题</a><time datetime="2024-04-18T03:31:35.000Z" title="发表于 2024-04-18 11:31:35">2024-04-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/blog/%E3%80%8AEffective-Java%E3%80%8B%E9%98%85%E8%AF%BB%E6%80%BB%E7%BB%93%EF%BC%9A%E7%B1%BB%E5%92%8C%E6%8E%A5%E5%8F%A3/" title="《Effective-Java》阅读总结：类和接口">《Effective-Java》阅读总结：类和接口</a><time datetime="2024-04-15T09:20:52.000Z" title="发表于 2024-04-15 17:20:52">2024-04-15</time></div></div></div></div><div class="card-widget card-categories"><div class="item-headline">
            <i class="fas fa-folder-open"></i>
            <span>分类</span>
            
            </div>
            <ul class="card-category-list" id="aside-cat-list">
            <li class="card-category-list-item "><a class="card-category-list-link" href="/blog/categories/GoF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><span class="card-category-list-name">GoF设计模式</span><span class="card-category-list-count">6</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/blog/categories/MIT-6-S081/"><span class="card-category-list-name">MIT 6.S081</span><span class="card-category-list-count">7</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/blog/categories/%E3%80%8AEffective-Java%E3%80%8B/"><span class="card-category-list-name">《Effective Java》</span><span class="card-category-list-count">1</span></a></li><li class="card-category-list-item "><a class="card-category-list-link" href="/blog/categories/%E6%83%B3%E6%88%90%E4%B8%BA%E7%AE%97%E6%B3%95%E9%AB%98%E6%89%8B/"><span class="card-category-list-name">想成为算法高手</span><span class="card-category-list-count">4</span></a></li>
            </ul></div><div class="card-widget card-tags"><div class="item-headline"><i class="fas fa-tags"></i><span>标签</span></div><div class="card-tag-cloud"><a href="/blog/tags/%E5%9B%BE%E8%AE%BA/" style="font-size: 1.23em; color: #999ea6">图论</a> <a href="/blog/tags/%E6%9A%91%E6%9C%9F%E5%AE%9E%E4%B9%A0/" style="font-size: 1.1em; color: #999">暑期实习</a> <a href="/blog/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.23em; color: #999ea6">算法</a> <a href="/blog/tags/%E6%8B%93%E6%89%91%E6%8E%92%E5%BA%8F/" style="font-size: 1.1em; color: #999">拓扑排序</a> <a href="/blog/tags/JUC/" style="font-size: 1.17em; color: #999c9f">JUC</a> <a href="/blog/tags/%E7%B1%BB%E5%92%8C%E6%8E%A5%E5%8F%A3%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%8C%87%E5%AF%BC%E5%8E%9F%E5%88%99/" style="font-size: 1.1em; color: #999">类和接口的设计指导原则</a> <a href="/blog/tags/DeadLock/" style="font-size: 1.1em; color: #999">DeadLock</a> <a href="/blog/tags/XV6/" style="font-size: 1.43em; color: #99a6b9">XV6</a> <a href="/blog/tags/%E5%BB%BA%E5%9B%BE%E6%96%B9%E6%B3%95/" style="font-size: 1.1em; color: #999">建图方法</a> <a href="/blog/tags/Stack-Frame/" style="font-size: 1.1em; color: #999">Stack Frame</a> <a href="/blog/tags/BFS/" style="font-size: 1.17em; color: #999c9f">BFS</a> <a href="/blog/tags/%E3%80%8AEffective-Java%E3%80%8B/" style="font-size: 1.1em; color: #999">《Effective Java》</a> <a href="/blog/tags/%E5%AD%98%E5%9B%BE%E6%96%B9%E6%B3%95/" style="font-size: 1.1em; color: #999">存图方法</a> <a href="/blog/tags/GoF%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 1.3em; color: #99a1ac">GoF设计模式</a> <a href="/blog/tags/DFS/" style="font-size: 1.1em; color: #999">DFS</a> <a href="/blog/tags/java/" style="font-size: 1.37em; color: #99a4b2">java</a> <a href="/blog/tags/%E4%BA%8C%E5%88%86/" style="font-size: 1.1em; color: #999">二分</a> <a href="/blog/tags/OS/" style="font-size: 1.5em; color: #99a9bf">OS</a> <a href="/blog/tags/%E7%AE%97%E6%B3%95%E5%9F%BA%E7%A1%80/" style="font-size: 1.1em; color: #999">算法基础</a></div></div><div class="card-widget card-archives"><div class="item-headline"><i class="fas fa-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/blog/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><span class="card-archive-list-count">13</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/blog/archives/2023/11/"><span class="card-archive-list-date">十一月 2023</span><span class="card-archive-list-count">8</span></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/blog/archives/2023/10/"><span class="card-archive-list-date">十月 2023</span><span class="card-archive-list-count">5</span></a></li></ul></div><div class="card-widget card-webinfo"><div class="item-headline"><i class="fas fa-chart-line"></i><span>网站资讯</span></div><div class="webinfo"><div class="webinfo-item"><div class="item-name">文章数目 :</div><div class="item-count">26</div></div><div class="webinfo-item"><div class="item-name">已运行时间 :</div><div class="item-count" id="runtimeshow" data-publishDate="2023-09-10T00:00:00.000Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">本站总字数 :</div><div class="item-count">51.2k</div></div><div class="webinfo-item"><div class="item-name">本站访客数 :</div><div class="item-count" id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">本站总访问量 :</div><div class="item-count" id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin"></i></div></div><div class="webinfo-item"><div class="item-name">最后更新时间 :</div><div class="item-count" id="last-push-date" data-lastPushDate="2024-04-23T08:01:08.595Z"><i class="fa-solid fa-spinner fa-spin"></i></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By why</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Good luck && Have fun</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/blog/js/utils.js"></script><script src="/blog/js/main.js"></script><script src="/blog/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"><script>window.typedJSFn = {
  init: (str) => {
    window.typed = new Typed('#subtitle', Object.assign({
      strings: str,
      startDelay: 300,
      typeSpeed: 150,
      loop: true,
      backSpeed: 50,
    }, null))
  },
  run: (subtitleType) => {
    if (true) {
      if (typeof Typed === 'function') {
        subtitleType()
      } else {
        getScript('https://cdn.jsdelivr.net/npm/typed.js/dist/typed.umd.min.js').then(subtitleType)
      }
    } else {
      subtitleType()
    }
  }
}
</script><script>function subtitleType () {
  if (true) {
    typedJSFn.init(["Never put off till tomorrow what you can do today","All problems in computer science can be solved by another level of indirection"])
  } else {
    document.getElementById("subtitle").textContent = "Never put off till tomorrow what you can do today"
  }
}
typedJSFn.run(subtitleType)</script></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法制,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="true" async="async"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>